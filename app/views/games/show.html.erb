<h2>
  Гра "<span class="coming-game"><%= @game.name %></span>"
</h2>

<% if @game.draft? %>
  <div class="is-draft-message">Чорновик</div>
<% end %>


<p>
  <em>Автори</em> - <strong><%= (@game.authors.map(&:nickname) + [@game.author.nickname]).uniq.join(', ') %></strong>
</p>

<% if user_signed_in? && (current_user.author_of?(@game) || @game.author_finished?) %>
  <p>
    <em>Сценарiй:</em> <strong><%=link_to 'доступний', show_scenario_game_path(@game) %></strong>
  </p>
<% end %>

<p>
  <% if @game.starts_at.nil? %>
    Дата початку гри ще не призначена
  <%  else  %>
    <em>Початок гри</em>: <%=  (@game.is_testing? ? @game.test_date : @game.starts_at).strftime('%H:%M %d.%m.%Y')  %>
  <%  end %>
</p>
<p>
  <% if @game.registration_deadline.nil? %>
    Кінцевий термін реєстрації ще не призначено
  <%  else  %>
    <em>Кінцевий термін реєстрації</em>: <%=  @game.registration_deadline.strftime('%H:%M %d.%m.%Y')  %>
  <%  end %>
</p>

<p>
  <em>Тип гри:</em> <%= @game.game_size || 'Лайт' %>
</p>

<p>
  <em>Послiдовнiсть проходження:</em> <%= @game.game_type == 'linear' ? ' Лiнiйна' : @game.game_type == 'panic' ? ' Штурм' : ' Лінійна (вказана)' %>
</p>

<% if @game.game_type == 'panic' %>
  <p>
    <em>Тривалiсть гри:</em> <%= " #{@game.duration} хвилин" %>
  </p>
<% end %>

<% unless @topic.nil? %>
  <p>
    <em>Обговорення:</em> <%= link_to " #{@topic.posts.count} повідомлень", forem.forum_topic_path(@topic.forum, @topic) %>
  </p>
<% end %>

<% if current_user&.captain? %>
    <p><% game_entry = GameEntry.of(current_user.team, @game)%>
      <%= render 'shared/game_entry_controls', game_entry: game_entry, game: @game, team: current_user.team %></p>
<% end %>
<br>

<p>
  <em>Опис:</em>
</p>
<p>
  <%= @game.description.html_safe %>
</p>

<p>
  <em>Максимальна кількість команд:</em>
</p>
<p>
  <% if @game.max_team_number.equal?(10000) || @game.max_team_number.equal?(0) || @game.max_team_number.nil? %>
    Необмежено
    <% @game.max_team_number = 10000 %>
  <% else %>
    <%= @game.max_team_number %>
  <% end %>
</p>

<br>

<% if user_signed_in? && current_user.author_of?(@game) %>

  <fieldset>
    <legend>
      Завдання:
    </legend>

    <p>
      <%= render 'levels/list', levels: @game.levels  %>
    </p>

    <p>
      <%= link_to "Додати нове завдання", new_game_level_path(@game) %>
    </p>
  </fieldset>
  <br>
<% end %>      

<%= render 'game_entries', game_entries: @game_entries  %>
<br>
<%= render 'teams', accepted_game_entries: @accepted_game_entries, game: @game %>
<br>

<% if user_signed_in? && current_user.author_of?(@game) %>
  <p>
    <%= link_to "Редагувати дану гру", edit_game_path(@game) %>
  </p>
  <br>
<% end %>

<% if @game.game_type == 'selected' && @teams_for_test.count > 0 %>
  <p><%= link_to 'Задати порядок проходження', url_for("/games/#{@game.id}/new_level_order") %></p>
<% end %>
<br>
<% if user_signed_in? %>
  <% if (@game.is_testing? ? @game.test_date : @game.starts_at) <= Time.zone.now.strftime("%d.%m.%Y %H:%M:%S.%L").to_time && !@game.author_finished? %>
    <div id="playButton"><%= link_to "Вхід у гру", url_for("/play/#{@game.id}") %></div>
  <% else %>
    <div id="playButton" style="display: none;"><%= link_to "Вхід у гру", url_for("/play/#{@game.id}") %></div>
  <% end %>
<% end %>
<br>
<p class="stat-link"><em><%= link_to "(статистика)", url_for("/logs/short/#{@game.id}") if @game.started? && !@game.is_testing? %></em></p>
<br>
<%= render 'shared/countdown' %>
<div id="countdown-example"></div>
<br>

<script type="text/javascript">
  <% unless @game.starts_at.nil? %>
    var seconds_to_game = <%= ((@game.is_testing? ? @game.test_date : @game.starts_at) - Time.zone.now.strftime("%d.%m.%Y %H:%M:%S.%L").to_time + 1) %>;
    var dateObj = Date.now();
    dateObj += 1000 * seconds_to_game;
    var date = new Date(dateObj);
  <% end %>

  $("#countdown-example").countdown(date, {
    prefix:'До початку лишилось: '
  });
</script>

<% if user_signed_in? && current_user.author_of?(@game) && !@game.started?&& !@game.is_testing? && @game.levels && @game.levels.count > 0 %>

    <% if game_with_personal? || @game.game_type == 'selected' %>
        <%= form_tag "/games/start_test/#{@game.id}", method: 'get' do %>
            <%= label_tag "Почати тестування для команди" %>
            <%= select_tag(:team_id, options_for_select(@teams_for_test.map{ |team| [team.name, team.id] })) %>
            <%= submit_tag "Старт" %>
        <% end %>
    <% else %>
        <%= link_to 'Почати тестування', url_for("/games/start_test/#{@game.id}") %>
    <% end %>

<% end %>

<% if user_signed_in? && current_user.author_of?(@game) && @game.is_testing? %>
   <%= link_to "Старт", url_for("/play/#{@game.id}") %>
   <br>
   <%= link_to "Завершити тестування", url_for("/games/finish_test/#{@game.id}") %>
<% end %>

<% if user_signed_in? && current_user.author_of?(@game) %>
  <br>
  <br>
  <br>
  <br>
  <%= link_to "ЗАВЕРШИТИ ГРУ", url_for("/games/end_game/#{@game.id}"), data: { confirm: 'Ви впевнені?' } if (@game.started? && !@game.is_testing? && !@game.author_finished?) %>
  <br>
  <%= "Ви завершили гру" if (@game.started? && !@game.is_testing? && @game.author_finished?) %>
  <br>
  <br>
  <br>
  <p>
    <%= link_to "Видалити дану гру", @game, method: :delete, data: { confirm: 'Ви впевнені?' } %>
  </p>
<% end %>
